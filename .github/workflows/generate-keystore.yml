name: Generate Keystore

on:
  workflow_dispatch:
    inputs:
      keystore_password:
        description: 'Keystore password'
        required: true
        default: 'ccpush123456'
      key_alias:
        description: 'Key alias'
        required: true
        default: 'ccpush'

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Generate Keystore
      run: |
        keytool -genkey -v -keystore release.keystore \
          -alias ${{ github.event.inputs.key_alias }} \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -storepass ${{ github.event.inputs.keystore_password }} \
          -keypass ${{ github.event.inputs.keystore_password }} \
          -dname "CN=CCPush, OU=Dev, O=Daoji, L=Beijing, ST=Beijing, C=CN"

    - name: Output Base64 Keystore
      id: keystore
      run: |
        echo "=========================================="
        echo "将以下内容保存到 GitHub Secrets:"
        echo "=========================================="
        echo ""
        echo "KEYSTORE_BASE64:"
        base64 -w 0 release.keystore
        echo ""
        echo ""
        echo "=========================================="
        echo "同时添加以下 Secrets:"
        echo "=========================================="
        echo "KEYSTORE_PASSWORD: ${{ github.event.inputs.keystore_password }}"
        echo "KEY_ALIAS: ${{ github.event.inputs.key_alias }}"
        echo "KEY_PASSWORD: ${{ github.event.inputs.keystore_password }}"

    - name: Upload Keystore as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-keystore
        path: release.keystore
        retention-days: 1
